# –ü—Ä–æ–µ–∫—Ç: ¬´–¶–∏—Ñ—Ä–æ–≤–æ–π –≠–∫–∑–æ–∫–æ—Ä—Ç–µ–∫—Å¬ª ‚Äî –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ë–∞–∑–∞ –ó–Ω–∞–Ω–∏–π —Å RAG

**–í–µ—Ä—Å–∏—è:**¬†11.0 (Expert-Reviewed Blueprint, Production-Ready)  
**–°—Ç–∞—Ç—É—Å:**¬†–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã)  
**–î–∞—Ç–∞:**¬†2024


```
[//]: # –≠—Ç–æ¬†**–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –ë–ª—é–ø—Ä–∏–Ω—Ç**. –û–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã¬†**"–ß–¢–û?"**¬†–∏¬†**"–ü–û–ß–ï–ú–£?"**. –û–Ω –∑–∞–¥–∞–µ—Ç –≤–∏–¥–µ–Ω–∏–µ, –ø—Ä–∏–Ω—Ü–∏–ø—ã, –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ –∏ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É. –ï–≥–æ —Å–∏–ª–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–æ–º, –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ü–µ–ª–µ–π –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Ä–µ—à–µ–Ω–∏–π.
```
---

## 1. TL;DR (–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ)

**–ß—Ç–æ —ç—Ç–æ:**¬†–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è RAG-—Å–∏—Å—Ç–µ–º–∞ –Ω–∞ –±–∞–∑–µ SiYuan, Qdrant –∏ Python, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ –±—é–¥–∂–µ—Ç–Ω–æ–º VPS (4vCPU/8GB RAM).

**–¶–µ–ª—å:**¬†–°–æ–∑–¥–∞—Ç—å ¬´–≤—Ç–æ—Ä–æ–π –º–æ–∑–≥¬ª, –∫–æ—Ç–æ—Ä—ã–π –¥–∞–µ—Ç —Ç–æ—á–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –∏ –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–∞—Ö, —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞—â–∏—Ç–æ–π –æ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π.

**–°—Ç–µ–∫:**

- –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫:¬†**–¥–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π**¬†(BM25 —Å –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π + –≤–µ–∫—Ç–æ—Ä—ã e5-small 384d) ‚Üí RRF fusion ‚Üí —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥ bge-m3 (ONNX)
- **Graceful degradation:**¬†Circuit breaker –¥–ª—è LLM API ‚Üí —ç–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA fallback ‚Üí —á–∏—Å—Ç—ã–π –ø–æ–∏—Å–∫
- –î–æ—Å—Ç—É–ø –∫ LLM —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é —Ä–æ—Ç–∞—Ü–∏—é –≤–Ω–µ—à–Ω–∏—Ö API —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º –ø–ª–∞—Ç–Ω—ã–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º

**–°—Ä–æ–∫–∏:**¬†MVP ‚Äî¬†**4-5 –Ω–µ–¥–µ–ª—å**¬†(–≤–∫–ª—é—á–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –Ω–∞ —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö).

**–°—Ç–æ–∏–º–æ—Å—Ç—å:**¬†VPS $10-20/–º–µ—Å + –ø–ª–∞—Ç–Ω—ã–π LLM fallback $5-10/–º–µ—Å.

---

## 2. –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏

### 2.1 –¢–æ—á–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–π –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫

**–Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã**¬†‚Äî –¥–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫:

1. **–®–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫:**
    
    - –í–µ–∫—Ç–æ—Ä–Ω—ã–π (Qdrant): top-200, —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –±–ª–∏–∑–æ—Å—Ç—å
    - –õ–µ–∫—Å–∏—á–µ—Å–∫–∏–π (SQLite FTS5 +¬†**pymorphy3**): top-200, –ª–µ–º–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π BM25
2. **Fusion:**¬†Reciprocal Rank Fusion (k=60) ‚Üí top-80 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    
3. **Reranking:**¬†Cross-encoder (bge-reranker-v2-m3) ‚Üí top-12 —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
    
4. **–ì—Ä–∞—Ñ–æ–≤–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ:**¬†1-hop –ø–æ —Å–≤—è–∑—è–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Üí +2-4 –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö —á–∞–Ω–∫–∞
    

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç v10.0:**¬†–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è¬†**–ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞**¬†–Ω–∞ —É—Ä–æ–≤–Ω–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∏ –ø–æ–∏—Å–∫–∞. –ë–µ–∑ —ç—Ç–æ–≥–æ recall –Ω–∞ —Ä—É—Å—Å–∫–æ–º —Å–Ω–∏–∂–∞–µ—Ç—Å—è –Ω–∞ 30-40%.

### 2.2 –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

text

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£—Ä–æ–≤–µ–Ω—å 1: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ + LLM (–æ—Å–Ω–æ–≤–Ω–æ–π) ‚îÇ
‚îÇ   - Circuit breaker –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ ‚îÇ
‚îÇ   - –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∫–µ—à (threshold=0.87)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£—Ä–æ–≤–µ–Ω—å 2: –≠–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA (ONNX, –ª–æ–∫–∞–ª—å–Ω–æ)‚îÇ
‚îÇ   - xlm-roberta-base-squad2                 ‚îÇ
‚îÇ   - –ü–æ–∫—Ä—ã–≤–∞–µ—Ç 60-70% —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ —Å confidence > 0.3
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£—Ä–æ–≤–µ–Ω—å 3: –†–µ–∂–∏–º "—Ç–æ–ª—å–∫–æ –ø–æ–∏—Å–∫"             ‚îÇ
‚îÇ   - –¢–æ–ø-3 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ + –≤—ã–¥–µ—Ä–∂–∫–∏ (highlight)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.3 –ö–æ–Ω—Ç—Ä–æ–ª—å –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π (Gating)

- **–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –ø–æ—Ä–æ–≥–∞:**¬†Platt scaling / –∏–∑–æ—Ç–æ–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–º –Ω–∞–±–æ—Ä–µ
- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**¬†JSON-—Å—Ö–µ–º–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
- **Confidence tracking:**¬†–í–æ–∑–≤—Ä–∞—Ç –º–µ—Ç—Ä–∏–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞ (low_coverage / low_agreement)

### 2.4 –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ

–ü—Ä–∏ –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (`max(scores) < 0.6`):

- `ef_search`: 64 ‚Üí 96 ‚Üí 128 (—Ç—Ä–∏ —Å—Ç—É–ø–µ–Ω–∏)
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π RRF —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏
- –ï—Å–ª–∏ –∏ —ç—Ç–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç ‚Üí fallback –Ω–∞ —É—Ä–æ–≤–µ–Ω—å 2

---

## 3. –¶–µ–ª–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### 3.1 –ó–æ–ª–æ—Ç–æ–π –Ω–∞–±–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤

**–†–∞–∑–º–µ—Ä:**¬†–°—Ç–∞—Ä—Ç ‚Äî 30 –≤–æ–ø—Ä–æ—Å–æ–≤, —Ü–µ–ª—å ‚Äî¬†**80-120 –≤–æ–ø—Ä–æ—Å–æ–≤**¬†(70% RU / 30% EN).

**–¢–∏–ø—ã:**

- 60% –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ ("–ö–∞–∫–∞—è —Å—Ç–æ–ª–∏—Ü–∞ X?")
- 40% –æ–±–∑–æ—Ä–Ω—ã–µ ("–û–±—ä—è—Å–Ω–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏—é Y")

### 3.2 –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

|–ú–µ—Ç—Ä–∏–∫–∞|–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ|–ò–∑–º–µ—Ä–µ–Ω–∏–µ|
|---|---|---|
|**Recall@15**¬†(–¥–æ —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞)|‚â• 0.80|–î–æ–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –≤ —Ç–æ–ø-15|
|**Recall@12**¬†(–ø–æ—Å–ª–µ —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞)|‚â• 0.85|–§–∏–Ω–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–ª—è LLM|
|**Groundedness (RAGAS)**|‚â• 0.80|–û—Ü–µ–Ω–∫–∞ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏|
|**Citation Precision**|‚â• 0.95|–î–æ–ª—è –≤–∞–ª–∏–¥–Ω—ã—Ö —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–π|
|**Fusion Gain**|‚â• +0.15|Œî Recall –º–µ–∂–¥—É –≥–∏–±—Ä–∏–¥–Ω—ã–º –∏ –ª—É—á—à–∏–º –º–æ–Ω–æ-–ø–æ–∏—Å–∫–æ–º|

### 3.3 Latency Budget (P95 –Ω–∞ 4vCPU)

|–≠—Ç–∞–ø|–¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è|–î–æ–ø—É—Å—Ç–∏–º–æ–µ –≤—Ä–µ–º—è|
|---|---|---|
|–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (Qdrant + FTS5)|‚â§ 1.0 —Å–µ–∫|1.5 —Å–µ–∫|
|RRF fusion|‚â§ 0.3 —Å–µ–∫|0.5 —Å–µ–∫|
|–†–µ—Ä–∞–Ω–∫–∏–Ω–≥ (80 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)|‚â§ 1.5 —Å–µ–∫|2.0 —Å–µ–∫|
|–ì—Ä–∞—Ñ–æ–≤–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ|‚â§ 0.4 —Å–µ–∫|0.6 —Å–µ–∫|
|LLM API (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º)|‚â§ 5.0 —Å–µ–∫|8.0 —Å–µ–∫|
|**–≠–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA (fallback)**|‚â§ 2.0 —Å–µ–∫|3.0 —Å–µ–∫|
|**–ò—Ç–æ–≥–æ (E2E, –æ—Å–Ω–æ–≤–Ω–æ–π)**|‚â§ 8.2 —Å–µ–∫|12.6 —Å–µ–∫|
|**–ò—Ç–æ–≥–æ (E2E, fallback)**|‚â§ 5.2 —Å–µ–∫|7.6 —Å–µ–∫|

---

## 4. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (MVP)

### 4.1 –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–Ω–∞–Ω–∏–π: SiYuan

**–ü—Ä–æ—Ü–µ—Å—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:**

- **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è:**¬†–ü–æ–ª–ª–∏–Ω–≥ –ø–æ¬†`updated_at`¬†(–∏–Ω—Ç–µ—Ä–≤–∞–ª: 5 –º–∏–Ω—É—Ç)
- **–ß–∞–Ω–∫–∏–Ω–≥:**¬†250-400 —Ç–æ–∫–µ–Ω–æ–≤, overlap 20-40 —Ç–æ–∫–µ–Ω–æ–≤, —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≥—Ä–∞–Ω–∏—Ü —Å–µ–∫—Ü–∏–π
- **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:**¬†SHA-256 —Ö—ç—à –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–∞–Ω–∫–∞
- **–ë–∞—Ç—á–∏–Ω–≥:**¬†1000-5000 —á–∞–Ω–∫–æ–≤ –∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∞:**

Python

```
{
    "block_id": str,        # ID –±–ª–æ–∫–∞ SiYuan
    "doc_id": str,          # ID –¥–æ–∫—É–º–µ–Ω—Ç–∞
    "section_path": str,    # –ò–µ—Ä–∞—Ä—Ö–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    "lang": str,            # ru/en (auto-detect)
    "created_at": int,      # timestamp
    "updated_at": int,
    "content_hash": str     # SHA-256
}
```

---

### 4.2 –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä: Thin Wrapper (Python)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**  
–û—Ç–∫–∞–∑ –æ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ LlamaIndex –≤ –ø–æ–ª—å–∑—É¬†**–º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π –æ–±–µ—Ä—Ç–∫–∏**¬†—Å –≤—ã–±–æ—Ä–æ—á–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

Python

```
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:
exocortex/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ embedder.py          # ONNX e5-small (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ –≤ RAM)
‚îÇ   ‚îú‚îÄ‚îÄ reranker.py          # Lazy-loaded bge-m3
‚îÇ   ‚îú‚îÄ‚îÄ extractive_qa.py     # ‚ú® –ù–û–í–û–ï: xlm-roberta fallback
‚îÇ   ‚îî‚îÄ‚îÄ semantic_cache.py    # ‚ú® –ù–û–í–û–ï: –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –∫–µ—à –æ—Ç–≤–µ—Ç–æ–≤
‚îú‚îÄ‚îÄ retrieval/
‚îÇ   ‚îú‚îÄ‚îÄ vector_store.py      # Qdrant wrapper
‚îÇ   ‚îú‚îÄ‚îÄ bm25_store.py        # ‚ú® –£–õ–£–ß–®–ï–ù–û: SQLite FTS5 + –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ fusion.py            # RRF (k=60)
‚îÇ   ‚îî‚îÄ‚îÄ graph_expander.py    # 1-hop —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ llm/
‚îÇ   ‚îú‚îÄ‚îÄ router.py            # ‚ú® –ù–û–í–û–ï: Circuit breaker + —Ä–æ—Ç–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ providers.py         # –ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è API
‚îî‚îÄ‚îÄ pipeline.py              # –ì–ª–∞–≤–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ LlamaIndex:**

- `resolve_embed_model()`¬†‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —É–¥–æ–±–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ ONNX –º–æ–¥–µ–ª–µ–π
- **–í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ**¬†‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (~500 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞)

**–í—ã–∏–≥—Ä—ã—à:**¬†–≠–∫–æ–Ω–æ–º–∏—è ~200 MB RAM, –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Ç–æ–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

---

### 4.3 –í–µ–∫—Ç–æ—Ä–Ω–∞—è –ø–∞–º—è—Ç—å –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫

#### 4.3.1 –í–µ–∫—Ç–æ—Ä–Ω–∞—è —á–∞—Å—Ç—å (Qdrant)

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏:**

YAML

```
vectors:
  size: 384
  distance: Cosine

quantization_config:
  scalar:
    type: int8
    quantile: 0.99
    always_ram: true

hnsw_config:
  m: 16                    # –ë–∞–ª–∞–Ω—Å —Ç–æ—á–Ω–æ—Å—Ç—å/–ø–∞–º—è—Ç—å
  ef_construct: 100
  
optimizers_config:
  memmap_threshold: 50000  # –ò—Å–ø–æ–ª—å–∑—É–µ–º mmap –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π
  
performance:
  max_search_threads: 2    # –ù–µ –±–æ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω—ã vCPU
```

**Payload –∏–Ω–¥–µ–∫—Å—ã:**

Python

```
# –î–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
client.create_payload_index(
    collection_name="chunks",
    field_name="lang",
    field_schema="keyword"
)
client.create_payload_index(
    collection_name="chunks",
    field_name="doc_id",
    field_schema="keyword"
)
```

**–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫:**

Python

```
async def adaptive_search(query_vector, confidence_threshold=0.6):
    # –ü–æ–ø—ã—Ç–∫–∞ 1: –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫
    results = await qdrant.search(
        vector=query_vector,
        limit=200,
        search_params={"ef": 64}
    )
    
    if max(r.score for r in results) < confidence_threshold:
        # –ü–æ–ø—ã—Ç–∫–∞ 2: —Å—Ä–µ–¥–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å
        results = await qdrant.search(
            vector=query_vector,
            limit=200,
            search_params={"ef": 96}
        )
    
    if max(r.score for r in results) < confidence_threshold:
        # –ü–æ–ø—ã—Ç–∫–∞ 3: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å
        results = await qdrant.search(
            vector=query_vector,
            limit=200,
            search_params={"ef": 128}
        )
    
    return results
```

#### 4.3.2 –õ–µ–∫—Å–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å (SQLite FTS5 + –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è) ‚ú®

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:**¬†–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫ —Å –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞.

**–°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã:**

SQL

```
-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —á–∞–Ω–∫–æ–≤
CREATE TABLE chunks (
    id INTEGER PRIMARY KEY,
    block_id TEXT UNIQUE NOT NULL,
    doc_id TEXT NOT NULL,
    content TEXT NOT NULL,
    content_lemma TEXT NOT NULL,  -- ‚ú® –ù–û–í–û–ï: –ª–µ–º–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    lang TEXT NOT NULL,
    section_path TEXT,
    created_at INTEGER,
    updated_at INTEGER,
    content_hash TEXT
);

-- FTS5 –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
CREATE VIRTUAL TABLE chunks_fts USING fts5(
    content,                      -- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç (–¥–ª—è EN)
    content_lemma,                -- –õ–µ–º–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (–¥–ª—è RU)
    block_id UNINDEXED,
    tokenize='unicode61 remove_diacritics 2'
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –≥—Ä–∞—Ñ–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
CREATE INDEX idx_doc_id ON chunks(doc_id);
CREATE INDEX idx_lang ON chunks(lang);
CREATE INDEX idx_hash ON chunks(content_hash);
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–µ–º–º–∞—Ç–∏–∑–∞—Ç–æ—Ä–∞:**

Python

```
from pymorphy3 import MorphAnalyzer
import re

class RussianLemmatizer:
    def __init__(self):
        self.morph = MorphAnalyzer()
        # –†—É—Å—Å–∫–∏–µ —Å—Ç–æ–ø-—Å–ª–æ–≤–∞ (—á–∞—Å—Ç–∏—Ü—ã, –ø—Ä–µ–¥–ª–æ–≥–∏)
        self.stopwords = set([
            '–∏', '–≤', '–≤–æ', '–Ω–µ', '—á—Ç–æ', '–æ–Ω', '–Ω–∞', '—è', '—Å', '—Å–æ',
            '–∫–∞–∫', '–∞', '—Ç–æ', '–≤—Å–µ', '–æ–Ω–∞', '—Ç–∞–∫', '–µ–≥–æ', '–Ω–æ', '–¥–∞',
            '—Ç—ã', '–∫', '—É', '–∂–µ', '–≤—ã', '–∑–∞', '–±—ã', '–ø–æ', '—Ç–æ–ª—å–∫–æ',
            '–µ–µ', '–º–Ω–µ', '–±—ã–ª–æ', '–≤–æ—Ç', '–æ—Ç', '–º–µ–Ω—è', '–µ—â–µ', '–Ω–µ—Ç',
            '–æ', '–∏–∑', '–µ–º—É', '—Ç–µ–ø–µ—Ä—å', '–∫–æ–≥–¥–∞', '–¥–∞–∂–µ', '–Ω—É', '–ø—Ä–∏'
        ])
    
    def lemmatize(self, text: str) -> str:
        """–õ–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç–æ–ø-—Å–ª–æ–≤"""
        tokens = re.findall(r'\w+', text.lower())
        lemmas = []
        
        for token in tokens:
            if token in self.stopwords:
                continue
            parsed = self.morph.parse(token)[0]
            lemmas.append(parsed.normal_form)
        
        return ' '.join(lemmas)
```

**PRAGMA-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

SQL

```
PRAGMA journal_mode = WAL;           -- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —á—Ç–µ–Ω–∏—è
PRAGMA synchronous = NORMAL;         -- –ë–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç—å/–Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
PRAGMA temp_store = MEMORY;          -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ RAM
PRAGMA mmap_size = 268435456;        -- 256 MB memory-mapped I/O
PRAGMA cache_size = -64000;          -- 64 MB –∫–µ—à —Å—Ç—Ä–∞–Ω–∏—Ü
```

**–ü–æ–∏—Å–∫ —Å —É—á–µ—Ç–æ–º —è–∑—ã–∫–∞:**

Python

```
async def bm25_search(query: str, lang: str, top_k: int = 200):
    # –õ–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ
    if lang == 'ru':
        query_processed = lemmatizer.lemmatize(query)
        column = 'content_lemma'
    else:
        query_processed = query.lower()
        column = 'content'
    
    results = cursor.execute(f"""
        SELECT 
            block_id,
            rank,
            snippet(chunks_fts, 0, '<mark>', '</mark>', '...', 32) as snippet
        FROM chunks_fts
        WHERE {column} MATCH ?
        ORDER BY rank
        LIMIT ?
    """, (query_processed, top_k))
    
    return results.fetchall()
```

#### 4.3.3 Reciprocal Rank Fusion (RRF)

Python

```
def reciprocal_rank_fusion(
    vector_results: list,
    bm25_results: list,
    k: int = 60,
    top_n: int = 80
) -> list:
    """
    –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å RRF.
    
    Args:
        k: –ü–∞—Ä–∞–º–µ—Ç—Ä —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (60 —ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏ –æ–ø—Ç–∏–º–∞–ª–µ–Ω)
        top_n: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞
    """
    scores = {}
    
    for rank, result in enumerate(vector_results, 1):
        doc_id = result.id
        scores[doc_id] = scores.get(doc_id, 0) + 1 / (k + rank)
    
    for rank, result in enumerate(bm25_results, 1):
        doc_id = result['block_id']
        scores[doc_id] = scores.get(doc_id, 0) + 1 / (k + rank)
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å–∫–æ—Ä—É, –±–µ—Ä–µ–º —Ç–æ–ø-N
    sorted_docs = sorted(scores.items(), key=lambda x: x[1], reverse=True)
    return sorted_docs[:top_n]
```

---

### 4.4 –õ–æ–∫–∞–ª—å–Ω—ã–µ ML-–º–æ–¥–µ–ª–∏ (ONNX)

#### 4.4.1 –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ –≤ RAM)

**–ú–æ–¥–µ–ª—å:**¬†`intfloat/multilingual-e5-small`¬†(384 dimensions)

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ONNX Runtime:**

Python

```
import onnxruntime as ort

session = ort.InferenceSession(
    "e5-small.onnx",
    providers=["CPUExecutionProvider"],
    sess_options={
        "intra_op_num_threads": 2,
        "inter_op_num_threads": 1,
        "execution_mode": ort.ExecutionMode.ORT_SEQUENTIAL,
        "graph_optimization_level": ort.GraphOptimizationLevel.ORT_ENABLE_ALL
    }
)

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
os.environ["OMP_NUM_THREADS"] = "2"
os.environ["MKL_NUM_THREADS"] = "2"
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤:**

Python

```
def embed_query(text: str):
    return model.encode(f"query: {text}")

def embed_passage(text: str):
    return model.encode(f"passage: {text}")
```

**–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏:**¬†~400 MB (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ)

#### 4.4.2 –†–µ—Ä–∞–Ω–∫–∏–Ω–≥ (lazy-loaded –ø—É–ª)

**–ú–æ–¥–µ–ª—å:**¬†`BAAI/bge-reranker-v2-m3`

Python

```
from datetime import datetime, timedelta

class LazyReranker:
    def __init__(self, model_path: str, idle_timeout: int = 600):
        self.model_path = model_path
        self.model = None
        self.last_used = None
        self.idle_timeout = timedelta(seconds=idle_timeout)
    
    def _load_model(self):
        self.model = ort.InferenceSession(
            self.model_path,
            providers=["CPUExecutionProvider"],
            sess_options={"intra_op_num_threads": 2}
        )
        self.last_used = datetime.now()
    
    def _unload_if_idle(self):
        if (self.model and self.last_used and 
            datetime.now() - self.last_used > self.idle_timeout):
            del self.model
            self.model = None
    
    async def rerank(self, query: str, documents: list, top_k: int = 12):
        self._unload_if_idle()
        
        if self.model is None:
            self._load_model()
        
        self.last_used = datetime.now()
        
        # –†–µ—Ä–∞–Ω–∫–∏–Ω–≥
        scores = self.model.run(
            None,
            {"query": query, "documents": documents}
        )
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø-K
        ranked = sorted(
            zip(documents, scores[0]),
            key=lambda x: x[1],
            reverse=True
        )
        return ranked[:top_k]
```

**–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏:**¬†~600 MB (–∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω–∞)

#### 4.4.3 –≠–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA Fallback ‚ú® –ù–û–í–û–ï

**–ú–æ–¥–µ–ª—å:**¬†`deepset/xlm-roberta-base-squad2`¬†(–ø–æ–¥–¥–µ—Ä–∂–∫–∞ RU/EN)

Python

```
from optimum.onnxruntime import ORTModelForQuestionAnswering
from transformers import AutoTokenizer

class ExtractiveFallback:
    def __init__(self, model_name: str = "deepset/xlm-roberta-base-squad2"):
        self.tokenizer = AutoTokenizer.from_pretrained(model_name)
        self.model = ORTModelForQuestionAnswering.from_pretrained(
            model_name,
            export=True,
            provider="CPUExecutionProvider"
        )
    
    def answer(
        self,
        question: str,
        contexts: list[str],
        confidence_threshold: float = 0.3
    ) -> dict | None:
        """
        –ü–æ–ø—ã—Ç–∫–∞ —ç–∫—Å—Ç—Ä–∞–∫—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤.
        
        Returns:
            {"text": str, "score": float, "context_id": int} –∏–ª–∏ None
        """
        for idx, context in enumerate(contexts[:3]):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ø-3
            inputs = self.tokenizer(
                question,
                context,
                return_tensors="pt",
                truncation=True,
                max_length=512
            )
            
            outputs = self.model(**inputs)
            
            # –î–µ–∫–æ–¥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            answer_start = outputs.start_logits.argmax()
            answer_end = outputs.end_logits.argmax() + 1
            answer = self.tokenizer.convert_tokens_to_string(
                self.tokenizer.convert_ids_to_tokens(
                    inputs["input_ids"][0][answer_start:answer_end]
                )
            )
            
            # –í—ã—á–∏—Å–ª—è–µ–º confidence
            score = (
                outputs.start_logits[0][answer_start] +
                outputs.end_logits[0][answer_end - 1]
            ).item() / 2
            
            if score > confidence_threshold:
                return {
                    "text": answer.strip(),
                    "score": score,
                    "context_id": idx,
                    "mode": "extractive"
                }
        
        return None
```

**–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏:**¬†~450 MB (lazy-loaded, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ä–µ—Ä–∞–Ω–∫–µ—Ä—É)

---

### 4.5 –ì—Ä–∞—Ñ–æ–≤–∞—è –ø–∞–º—è—Ç—å (SQLite + NetworkX)

**–°—Ö–µ–º–∞ –≥—Ä–∞—Ñ–∞:**

SQL

```
CREATE TABLE graph_edges (
    id INTEGER PRIMARY KEY,
    source_block_id TEXT NOT NULL,
    target_block_id TEXT NOT NULL,
    edge_type TEXT NOT NULL,  -- 'parent', 'child', 'ref', 'sibling', 'prev', 'next'
    weight REAL DEFAULT 1.0,
    UNIQUE(source_block_id, target_block_id, edge_type)
);

CREATE INDEX idx_source ON graph_edges(source_block_id, edge_type);
CREATE INDEX idx_target ON graph_edges(target_block_id, edge_type);
```

**1-hop —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ:**

Python

```
async def expand_context(seed_blocks: list[str], max_neighbors: int = 4):
    """
    –†–∞—Å—à–∏—Ä—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ 1 —à–∞–≥ –ø–æ –≥—Ä–∞—Ñ—É —Å–≤—è–∑–µ–π.
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: parent > ref > sibling > next
    """
    expanded = []
    
    for block_id in seed_blocks:
        neighbors = cursor.execute("""
            SELECT target_block_id, edge_type, weight
            FROM graph_edges
            WHERE source_block_id = ?
            ORDER BY 
                CASE edge_type
                    WHEN 'parent' THEN 1
                    WHEN 'ref' THEN 2
                    WHEN 'sibling' THEN 3
                    WHEN 'next' THEN 4
                    ELSE 5
                END,
                weight DESC
            LIMIT ?
        """, (block_id, max_neighbors))
        
        expanded.extend([row[0] for row in neighbors.fetchall()])
    
    return expanded
```

**Offline –∞–Ω–∞–ª–∏–∑ (NetworkX):**

Python

```
import networkx as nx

def analyze_graph_offline(db_path: str):
    """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è PageRank –∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤"""
    G = nx.DiGraph()
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ SQLite
    edges = cursor.execute("SELECT source_block_id, target_block_id, weight FROM graph_edges")
    for src, tgt, weight in edges:
        G.add_edge(src, tgt, weight=weight)
    
    # PageRank –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–∞–∂–Ω–æ—Å—Ç–∏ –±–ª–æ–∫–æ–≤
    pagerank = nx.pagerank(G, weight='weight')
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    cursor.executemany(
        "INSERT OR REPLACE INTO block_metrics (block_id, pagerank) VALUES (?, ?)",
        pagerank.items()
    )
```

---

### 4.6 LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∏ —Ä–æ—Ç–∞—Ü–∏—è ‚ú® –£–õ–£–ß–®–ï–ù–û

#### 4.6.1 Circuit Breaker + –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è

Python

```
from circuitbreaker import circuit
from datetime import datetime, timedelta
import asyncio

class LLMProvider:
    def __init__(
        self,
        name: str,
        api_key: str,
        base_url: str,
        is_free: bool,
        rate_limit: str  # "30/10min"
    ):
        self.name = name
        self.api_key = api_key
        self.base_url = base_url
        self.is_free = is_free
        self.rate_limit = rate_limit
        
        # –ú–µ—Ç—Ä–∏–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
        self.errors_count = 0
        self.total_requests = 0
        self.latencies = []  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–∞–ø—Ä–æ—Å–æ–≤
        self.last_error = None

class LLMRouter:
    def __init__(self, providers: list[LLMProvider]):
        self.providers = providers
        self.semantic_cache = SemanticCache(threshold=0.87, ttl_days=7)
    
    def _get_provider_score(self, provider: LLMProvider) -> float:
        """
        –°–∫–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞: —á–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º –ª—É—á—à–µ.
        –£—á–∏—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å.
        """
        error_penalty = provider.errors_count * 10
        latency_penalty = (
            sum(provider.latencies[-20:]) / len(provider.latencies[-20:])
            if provider.latencies else 0
        )
        free_bonus = -5 if provider.is_free else 0  # –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ
        
        return error_penalty + latency_penalty + free_bonus
    
    @circuit(failure_threshold=3, recovery_timeout=60, expected_exception=Exception)
    async def _call_provider(
        self,
        provider: LLMProvider,
        prompt: str,
        timeout: float = 8.0
    ) -> str:
        """–í—ã–∑–æ–≤ —Å circuit breaker"""
        start_time = datetime.now()
        
        try:
            async with asyncio.timeout(timeout):
                response = await self._make_api_request(provider, prompt)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
            latency = (datetime.now() - start_time).total_seconds()
            provider.latencies.append(latency)
            provider.total_requests += 1
            provider.errors_count = max(0, provider.errors_count - 0.5)  # Decay
            
            return response
            
        except Exception as e:
            provider.errors_count += 1
            provider.last_error = str(e)
            raise
    
    async def generate(
        self,
        prompt: str,
        query_embedding: np.ndarray = None
    ) -> dict | None:
        """
        –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å –∫–µ—à–µ–º –∏ —Ä–æ—Ç–∞—Ü–∏–µ–π.
        """
        # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–µ—à–∞
        if query_embedding is not None:
            cached = self.semantic_cache.get(query_embedding)
            if cached:
                return {"answer": cached, "source": "cache"}
        
        # –®–∞–≥ 2: –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –ø–æ –∑–¥–æ—Ä–æ–≤—å—é
        sorted_providers = sorted(
            self.providers,
            key=self._get_provider_score
        )
        
        # –®–∞–≥ 3: –ü—Ä–æ–±—É–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –ø–æ –æ—á–µ—Ä–µ–¥–∏
        last_error = None
        for provider in sorted_providers:
            try:
                response = await self._call_provider(provider, prompt)
                
                # –£—Å–ø–µ—Ö - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
                if query_embedding is not None:
                    self.semantic_cache.set(query_embedding, response)
                
                return {
                    "answer": response,
                    "source": provider.name,
                    "is_free": provider.is_free
                }
                
            except CircuitBreakerError:
                # –ü—Ä–æ–≤–∞–π–¥–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π
                continue
            except Exception as e:
                last_error = e
                continue
        
        # –í—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
        return None
```

#### 4.6.2 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

Python

```
providers = [
    LLMProvider(
        name="groq-llama3-70b",
        api_key=os.getenv("GROQ_API_KEY"),
        base_url="https://api.groq.com/openai/v1",
        is_free=True,
        rate_limit="30/10min"
    ),
    LLMProvider(
        name="openrouter-free",
        api_key=os.getenv("OPENROUTER_API_KEY"),
        base_url="https://openrouter.ai/api/v1",
        is_free=True,
        rate_limit="10/min"
    ),
    LLMProvider(
        name="openai-gpt4o-mini",  # ‚ú® –ü–ª–∞—Ç–Ω—ã–π fallback
        api_key=os.getenv("OPENAI_API_KEY"),
        base_url="https://api.openai.com/v1",
        is_free=False,
        rate_limit="500/min"
    )
]

router = LLMRouter(providers)
```

**–ë—é–¥–∂–µ—Ç:**¬†–ü–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö. –ü—Ä–∏ 3k —Ç–æ–∫–µ–Ω–æ–≤/–∑–∞–ø—Ä–æ—Å –∏ —Ü–µ–Ω–µ GPT-4o-mini $0.15/1M —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí $0.00045/–∑–∞–ø—Ä–æ—Å. –ë—é–¥–∂–µ—Ç $5/–º–µ—Å = ~11,000 fallback-–∑–∞–ø—Ä–æ—Å–æ–≤.

---

### 4.7 –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∫–µ—à ‚ú® –ù–û–í–û–ï

Python

```
import numpy as np
from datetime import datetime, timedelta
from collections import OrderedDict

class SemanticCache:
    """
    LRU-–∫–µ—à —Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–º –ø–æ–∏—Å–∫–æ–º –ø–æ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–π –±–ª–∏–∑–æ—Å—Ç–∏.
    """
    def __init__(
        self,
        threshold: float = 0.87,
        ttl_days: int = 7,
        max_size: int = 1000
    ):
        self.threshold = threshold
        self.ttl = timedelta(days=ttl_days)
        self.max_size = max_size
        self.cache = OrderedDict()  # {query_id: (embedding, response, timestamp)}
    
    def _cleanup_expired(self):
        """–£–¥–∞–ª—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–ø–∏—Å–∏"""
        now = datetime.now()
        expired = [
            qid for qid, (_, _, ts) in self.cache.items()
            if now - ts > self.ttl
        ]
        for qid in expired:
            del self.cache[qid]
    
    def get(self, query_embedding: np.ndarray) -> str | None:
        """–ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ –∫–µ—à–µ"""
        self._cleanup_expired()
        
        for qid, (cached_emb, response, ts) in self.cache.items():
            similarity = np.dot(query_embedding, cached_emb) / (
                np.linalg.norm(query_embedding) * np.linalg.norm(cached_emb)
            )
            
            if similarity >= self.threshold:
                # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –∫–æ–Ω–µ—Ü (LRU)
                self.cache.move_to_end(qid)
                return response
        
        return None
    
    def set(self, query_embedding: np.ndarray, response: str):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –∫–µ—à"""
        qid = hash(query_embedding.tobytes())
        
        # LRU eviction
        if len(self.cache) >= self.max_size:
            self.cache.popitem(last=False)
        
        self.cache[qid] = (query_embedding, response, datetime.now())
```

**Impact:**¬†–û–∂–∏–¥–∞–µ–º–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ LLM-–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 30-40% –ø–æ—Å–ª–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∫–µ—à–∞.

---

## 5. –ì–ª–∞–≤–Ω—ã–π Pipeline (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)

Python

```
class ExocortexRAG:
    def __init__(self):
        self.embedder = ONNXEmbedder("e5-small.onnx")
        self.vector_store = QdrantClient(...)
        self.bm25_store = BM25Store(db_path="chunks.db")
        self.reranker = LazyReranker("bge-reranker-v2-m3.onnx")
        self.graph = GraphExpander(db_path="chunks.db")
        self.llm_router = LLMRouter(providers)
        self.extractive_qa = ExtractiveFallback()
        self.semantic_cache = SemanticCache()
    
    async def query(self, user_query: str, lang: str = "ru") -> dict:
        """
        –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ —Å graceful degradation.
        """
        trace_id = uuid.uuid4()
        start_time = datetime.now()
        
        # –≠—Ç–∞–ø 1: –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query_embedding = self.embedder.encode_query(user_query)
        
        # –≠—Ç–∞–ø 2: –î–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π –ø–æ–∏—Å–∫
        vector_results = await self.vector_store.search(
            vector=query_embedding,
            limit=200,
            ef_search=64  # –ê–¥–∞–ø—Ç–∏–≤–Ω–æ –ø–æ–≤—ã—Å–∏—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        )
        
        bm25_results = await self.bm25_store.search(
            query=user_query,
            lang=lang,
            top_k=200
        )
        
        # –≠—Ç–∞–ø 3: RRF Fusion
        fused_results = reciprocal_rank_fusion(
            vector_results,
            bm25_results,
            k=60,
            top_n=80
        )
        
        # –≠—Ç–∞–ø 4: Reranking
        reranked = await self.reranker.rerank(
            query=user_query,
            documents=[r['content'] for r in fused_results],
            top_k=12
        )
        
        # –≠—Ç–∞–ø 5: –ì—Ä–∞—Ñ–æ–≤–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
        seed_blocks = [r['block_id'] for r in reranked]
        expanded_blocks = await self.graph.expand_context(
            seed_blocks,
            max_neighbors=4
        )
        
        final_contexts = reranked + expanded_blocks[:4]
        
        # –≠—Ç–∞–ø 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (—Å fallback)
        response = await self._generate_with_fallback(
            query=user_query,
            contexts=final_contexts,
            query_embedding=query_embedding,
            trace_id=trace_id
        )
        
        # –ú–µ—Ç—Ä–∏–∫–∏
        latency = (datetime.now() - start_time).total_seconds()
        
        return {
            **response,
            "trace_id": str(trace_id),
            "latency_ms": latency * 1000,
            "num_contexts": len(final_contexts)
        }
    
    async def _generate_with_fallback(
        self,
        query: str,
        contexts: list,
        query_embedding: np.ndarray,
        trace_id: uuid.UUID
    ) -> dict:
        """
        –¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞.
        """
        # –£—Ä–æ–≤–µ–Ω—å 1: LLM —á–µ—Ä–µ–∑ —Ä–æ—Ç–∞—Ü–∏—é –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
        prompt = self._build_prompt(query, contexts)
        llm_response = await self.llm_router.generate(
            prompt=prompt,
            query_embedding=query_embedding
        )
        
        if llm_response:
            answer = self._parse_json_response(llm_response['answer'])
            if answer and answer.get('confidence', 0) > 0.6:
                return {
                    "answer": answer['answer'],
                    "citations": answer['citations'],
                    "confidence": answer['confidence'],
                    "mode": "llm",
                    "llm_provider": llm_response['source']
                }
        
        # –£—Ä–æ–≤–µ–Ω—å 2: –≠–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA (–ª–æ–∫–∞–ª—å–Ω–æ)
        extractive_answer = self.extractive_qa.answer(
            question=query,
            contexts=[c['content'] for c in contexts]
        )
        
        if extractive_answer:
            return {
                "answer": extractive_answer['text'],
                "citations": [contexts[extractive_answer['context_id']]],
                "confidence": extractive_answer['score'],
                "mode": "extractive"
            }
        
        # –£—Ä–æ–≤–µ–Ω—å 3: –¢–æ–ª—å–∫–æ –ø–æ–∏—Å–∫ —Å –≤—ã–¥–µ—Ä–∂–∫–∞–º–∏
        return {
            "answer": "",
            "contexts": contexts[:3],
            "snippets": [c['snippet'] for c in contexts[:3]],
            "confidence": 0.0,
            "mode": "search_only",
            "message": "–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã, –Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω"
        }
    
    def _build_prompt(self, query: str, contexts: list) -> str:
        """
        –ü—Ä–æ–º–ø—Ç —Å –∂–µ—Å—Ç–∫–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º JSON-—Ñ–æ—Ä–º–∞—Ç–∞.
        """
        context_text = "\n\n".join([
            f"[{i+1}] {c['content']} (ID: {c['block_id']})"
            for i, c in enumerate(contexts)
        ])
        
        return f"""–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É—è –¢–û–õ–¨–ö–û –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã.

–í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞, –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π answer –∏ confidence=0.0
- –ö–∞–∂–¥–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–π —Ü–∏—Ç–∞—Ç–æ–π
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –°–¢–†–û–ì–û –≤ JSON-—Ñ–æ—Ä–º–∞—Ç–µ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

–ö–û–ù–¢–ï–ö–°–¢–´:
{context_text}

–í–û–ü–†–û–°: {query}

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON):
{{
  "answer": "—Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ —Å —Ñ–∞–∫—Ç–∞–º–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤",
  "citations": [
    {{"block_id": "ID –±–ª–æ–∫–∞", "quote": "—Ç–æ—á–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞", "relevance": 0.95}}
  ],
  "confidence": 0.85
}}"""
    
    def _parse_json_response(self, raw_response: str) -> dict | None:
        """–ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è JSON-–æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM"""
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ markdown-–±–ª–æ–∫–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            json_match = re.search(r'```json\s*(\{.*?\})\s*```', raw_response, re.DOTALL)
            if json_match:
                raw_response = json_match.group(1)
            
            data = json.loads(raw_response)
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º—ã
            required_keys = {'answer', 'citations', 'confidence'}
            if not required_keys.issubset(data.keys()):
                return None
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–∏—Ç–∞—Ç
            for cite in data['citations']:
                if 'block_id' not in cite:
                    return None
            
            return data
            
        except json.JSONDecodeError:
            return None
```

---

## 6. –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ä–∞–∑–≤–∏—Ç–∏—è (Roadmap)

### üìÖ –§–∞–∑–∞ 1: MVP (4-5 –Ω–µ–¥–µ–ª—å)

#### –ù–µ–¥–µ–ª—è 1: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **–î–µ–Ω—å 1-2:**
    
    - [ ] ¬†–ù–∞—Å—Ç—Ä–æ–π–∫–∞ VPS (Ubuntu 24.04)
    - [ ] ¬†–£—Å—Ç–∞–Ω–æ–≤–∫–∞ zram (4GB, zstd compression)
    - [ ] ¬†Docker + Docker Compose
    - [ ] ¬†–ù–∞—Å—Ç—Ä–æ–π–∫–∞ UFW, Traefik —Å TLS
    - [ ] ¬†–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Netdata –∏–ª–∏ cAdvisor)
- **–î–µ–Ω—å 3-5:**
    
    - [ ] ¬†‚ú® –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è pymorphy3
    - [ ] ¬†SQLite FTS5: —Å—Ö–µ–º–∞ + –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è + —Å—Ç–æ–ø-—Å–ª–æ–≤–∞ RU
    - [ ] ¬†–ë–µ–Ω—á–º–∞—Ä–∫ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞ 10k –±–ª–æ–∫–æ–≤
    - [ ] ¬†–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ BM25-–ø–æ–∏—Å–∫–∞ –Ω–∞ RU
- **–î–µ–Ω—å 6-7:**
    
    - [ ] ¬†–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Qdrant (–∫–æ–ª–ª–µ–∫—Ü–∏—è + –∫–≤–∞–Ω—Ç–∏–∑–∞—Ü–∏—è)
    - [ ] ¬†ONNX e5-small: –∑–∞–≥—Ä—É–∑–∫–∞ + –±–µ–Ω—á–º–∞—Ä–∫ (latency, RAM)
    - [ ] ¬†–ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞ (1000 –±–ª–æ–∫–æ–≤)

#### –ù–µ–¥–µ–ª—è 2: –ü–æ–∏—Å–∫–æ–≤—ã–π Pipeline

- **–î–µ–Ω—å 8-10:**
    
    - [ ] ¬†–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (ef_search: 64‚Üí96‚Üí128)
    - [ ] ¬†–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è BM25 + –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
    - [ ] ¬†RRF fusion (k=60, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å 40/60/80)
- **–î–µ–Ω—å 11-12:**
    
    - [ ] ¬†ONNX bge-reranker-v2-m3
    - [ ] ¬†Lazy-loading –ø—É–ª —Å —Ç–∞–π–º–∞—É—Ç–æ–º 10 –º–∏–Ω—É—Ç
    - [ ] ¬†–ë–µ–Ω—á–º–∞—Ä–∫ —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞: 50/80/100 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ‚Üí –≤—ã–±–æ—Ä –æ–ø—Ç–∏–º—É–º–∞
- **–î–µ–Ω—å 13-14:**
    
    - [ ] ¬†‚ú® –≠–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA: xlm-roberta-base-squad2 ONNX
    - [ ] ¬†–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ fallback-–ª–æ–≥–∏–∫—É
    - [ ] ¬†–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 20 —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö

#### –ù–µ–¥–µ–ª—è 3: LLM –∏ –ì—Ä–∞—Ñ

- **–î–µ–Ω—å 15-17:**
    
    - [ ] ¬†LLMRouter: circuit breaker + —Å–∫–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
    - [ ] ¬†–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Groq + OpenRouter + OpenAI (fallback)
    - [ ] ¬†‚ú® –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∫–µ—à (threshold=0.87, TTL=7d)
    - [ ] ¬†–°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç —Ä–æ—Ç–∞—Ü–∏–∏ (–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–∫–∞–∑—ã)
- **–î–µ–Ω—å 18-19:**
    
    - [ ] ¬†JSON-—Å—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ + –≤–∞–ª–∏–¥–∞—Ç–æ—Ä
    - [ ] ¬†–ü—Ä–æ–º–ø—Ç-–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥ (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö)
    - [ ] ¬†–û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON, –æ—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç–∞)
- **–î–µ–Ω—å 20-21:**
    
    - [ ] ¬†–ì—Ä–∞—Ñ: —Å—Ö–µ–º–∞ SQLite + –∏–Ω–¥–µ–∫—Å—ã
    - [ ] ¬†1-hop —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    - [ ] ¬†A/B —Ç–µ—Å—Ç: —Å –≥—Ä–∞—Ñ–æ–≤—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º vs –±–µ–∑

#### –ù–µ–¥–µ–ª—è 4: –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∏ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- **–î–µ–Ω—å 22-24:**
    
    - [ ] ¬†–ó–æ–ª–æ—Ç–æ–π –Ω–∞–±–æ—Ä: 30 –≤–æ–ø—Ä–æ—Å–æ–≤ (21 RU / 9 EN, —Ñ–∞–∫—Ç/–æ–±–∑–æ—Ä)
    - [ ] ¬†–û—Ñ–ª–∞–π–Ω-–º–µ—Ç—Ä–∏–∫–∏: Recall@15, Recall@12, Fusion Gain
    - [ ] ¬†–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ gating-–ø–æ—Ä–æ–≥–∞ (Platt scaling)
- **–î–µ–Ω—å 25-26:**
    
    - [ ] ¬†Load testing: 10 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –∏–∑–º–µ—Ä–µ–Ω–∏–µ P95 latency
    - [ ] ¬†–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ OOM-—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ swap/zram)
    - [ ] ¬†Streamlit UI –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **–î–µ–Ω—å 27-28:**
    
    - [ ] ¬†–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±—ç–∫–∞–ø–æ–≤ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ, –Ω–∞ –≤–Ω–µ—à–Ω–∏–π storage)
    - [ ] ¬†–£—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞
    - [ ] ¬†–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É

#### –ù–µ–¥–µ–ª—è 5: –ë—É—Ñ–µ—Ä –∏ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–î–µ–Ω—å 29-35:**
    - [ ] ¬†–û—Ç–ª–∞–¥–∫–∞ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
    - [ ] ¬†–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–∫–∏—Ö –º–µ—Å—Ç (–µ—Å–ª–∏ P95 > budget)
    - [ ] ¬†–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: README, API-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è, runbook
    - [ ] ¬†–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ Go-Live

---

### üìÖ –§–∞–∑–∞ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (2-3 –Ω–µ–¥–µ–ª–∏)

- **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞:**¬†–î–æ 80-120 –≤–æ–ø—Ä–æ—Å–æ–≤
- **–ü–ª–∞–Ω–æ–≤–∞—è —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è:**
    - –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–µ—à–∞ (threshold tuning)
    - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ RRF-–≤–µ—Å–æ–≤
- **WebSocket API SiYuan:**¬†Real-time –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ –ø–æ–ª–ª–∏–Ω–≥–∞
- **Advanced –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
    - Prometheus + Grafana
    - –ê–ª–µ—Ä—Ç—ã –Ω–∞ OOM, high latency, LLM failures
- **PII-–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ:**¬†–†–µ–≥—ç–∫—Å–ø—ã –¥–ª—è email/—Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ LLM

---

### üìÖ –§–∞–∑–∞ 3: "–í–∑—Ä–æ—Å–ª–µ–Ω–∏–µ" –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (4-6 –Ω–µ–¥–µ–ª—å)

- **–ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞–∑ –æ—Ç LlamaIndex:**¬†–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã
- **MCP/HTTP API:**¬†REST/WebSocket —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∞–≥–µ–Ω—Ç–∞–º–∏
- **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è:**
    - –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–¥–±–µ–∫–∞
    - User-specific –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
- **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –≥—Ä–∞—Ñ:**
    - PageRank –¥–ª—è –≤–µ—Å–æ–≤ –±–ª–æ–∫–æ–≤
    - –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    - –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–æ–≤–∏–∑–Ω–∞ vs —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)

---

## 7. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è

### 7.1 –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ VPS

#### Zram –≤–º–µ—Å—Ç–æ swap ‚ú®

Bash

```
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ zram-tools
sudo apt install zram-tools

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è /etc/default/zramswap
ALGO=zstd              # –ë—ã—Å—Ç—Ä–æ–µ —Å–∂–∞—Ç–∏–µ
PERCENT=50             # 4GB –¥–ª—è 8GB RAM
PRIORITY=100

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
sudo service zramswap reload

# –ü—Ä–æ–≤–µ—Ä–∫–∞
sudo zramctl
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**¬†Zram –≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ swap, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∂–∞—Ç—É—é RAM –≤–º–µ—Å—Ç–æ I/O.

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è ONNX

Bash

```
# docker-compose.yml
environment:
  - OMP_NUM_THREADS=2
  - MKL_NUM_THREADS=2
  - ONNXRUNTIME_MAX_THREADS=2
```

#### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏

Python

```
import psutil
import logging

async def memory_watchdog():
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π graceful restart –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏ RAM"""
    while True:
        mem = psutil.virtual_memory()
        
        if mem.percent > 90:
            logging.critical(f"RAM usage critical: {mem.percent}%")
            # –í—ã–≥—Ä—É–∂–∞–µ–º lazy-loaded –º–æ–¥–µ–ª–∏
            reranker.unload()
            extractive_qa.unload()
        
        await asyncio.sleep(30)
```

---

### 7.2 –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### –°–µ—Ç–µ–≤–∞—è –∏–∑–æ–ª—è—Ü–∏—è

YAML

```
# docker-compose.yml
networks:
  internal:
    driver: bridge
    internal: true  # –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Ç—å –¥–ª—è –ë–î
  
  external:
    driver: bridge

services:
  qdrant:
    networks:
      - internal
  
  app:
    networks:
      - internal
      - external
  
  traefik:
    networks:
      - external
```

#### TLS –∏ Firewall

Bash

```
# UFW –ø—Ä–∞–≤–∏–ª–∞
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp   # SSH (—Ç–æ–ª—å–∫–æ —Å –±–µ–ª–æ–≥–æ IP)
sudo ufw allow 80/tcp   # HTTP ‚Üí HTTPS redirect
sudo ufw allow 443/tcp  # HTTPS
sudo ufw enable

# Traefik –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
```

#### Secrets Management

Bash

```
# .env (–Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ Git)
GROQ_API_KEY=gsk_...
OPENROUTER_API_KEY=sk-or-...
OPENAI_API_KEY=sk-...
QDRANT_API_KEY=...

# Docker secrets (production)
echo "gsk_..." | docker secret create groq_api_key -
```

---

### 7.3 –ë—ç–∫–∞–ø—ã –∏ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

#### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –±—ç–∫–∞–ø–æ–≤

Bash

```
#!/bin/bash
# backup.sh - –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±—ç–∫–∞–ø (cron: 0 3 * * *)

DATE=$(date +%Y%m%d)
BACKUP_DIR="/mnt/backup-volume"  # –í–Ω–µ—à–Ω–∏–π volume (–Ω–µ –Ω–∞ VPS!)

# Qdrant snapshot
docker exec qdrant curl -X POST http://localhost:6333/collections/chunks/snapshots

# SQLite + –≥—Ä–∞—Ñ
sqlite3 /opt/exocortex/data/chunks.db ".backup ${BACKUP_DIR}/chunks_${DATE}.db"

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
tar -czf ${BACKUP_DIR}/config_${DATE}.tar.gz /opt/exocortex/config/

# –†–æ—Ç–∞—Ü–∏—è (—Ö—Ä–∞–Ω–∏–º 30 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–Ω–µ–π + 12 –º–µ—Å—è—á–Ω—ã—Ö)
find ${BACKUP_DIR} -name "*.db" -mtime +30 -delete
```

#### –£—á–µ–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–µ–∂–µ–º–µ—Å—è—á–Ω–æ)

Bash

```
# restore-drill.sh
# 1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π Docker Compose stack
# 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø
# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é (golden set)
# 4. –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
```

---

### 7.4 –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏

Python

```
import structlog

logger = structlog.get_logger()

# –í –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
logger.info(
    "query_completed",
    trace_id=str(trace_id),
    query_length=len(user_query),
    num_contexts=len(final_contexts),
    mode=response['mode'],
    latency_ms=latency,
    llm_provider=response.get('llm_provider'),
    cache_hit=response.get('source') == 'cache'
)
```

#### –ú–µ—Ç—Ä–∏–∫–∏ (Prometheus-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ)

Python

```
from prometheus_client import Counter, Histogram, Gauge

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
query_counter = Counter('rag_queries_total', 'Total queries', ['mode', 'lang'])
latency_histogram = Histogram('rag_latency_seconds', 'Query latency', ['stage'])
cache_hit_rate = Gauge('rag_cache_hit_rate', 'Semantic cache hit rate')

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
query_counter.labels(mode='llm', lang='ru').inc()
latency_histogram.labels(stage='reranking').observe(1.2)
```

---

## 8. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏)

|–ü–∞—Ä–∞–º–µ—Ç—Ä|–°—Ç–∞—Ä—Ç|–ß–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞|–ß–µ—Ä–µ–∑ 12 –º–µ—Å—è—Ü–µ–≤|
|---|---|---|---|
|**–û–±—ä–µ–º –∏–Ω–¥–µ–∫—Å–∞**|50-100k —á–∞–Ω–∫–æ–≤|200-300k|500k-1M|
|**–†–∞–∑–º–µ—Ä –≤–µ–∫—Ç–æ—Ä–∞ –ë–î**|~40 MB|~115 MB|~290 MB|
|**–ó–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å**|10-20|50-100|200-300|
|**–î–æ–ª—è –∫–µ—à-—Ö–∏—Ç–æ–≤**|5-10% (—Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç)|30-40%|50-60%|

**–Ø–∑—ã–∫–æ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**¬†70% —Ä—É—Å—Å–∫–∏–π, 30% –∞–Ω–≥–ª–∏–π—Å–∫–∏–π

**–¢–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤:**

- 60% –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ ("–ö–æ–≥–¥–∞ –æ—Å–Ω–æ–≤–∞–Ω X?")
- 40% –æ–±–∑–æ—Ä–Ω—ã–µ ("–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Y?")

**–ë—é–¥–∂–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ LLM:**¬†~3000 —Ç–æ–∫–µ–Ω–æ–≤ (12 —á–∞–Ω–∫–æ–≤ –ø–æ ~200 —Ç–æ–∫–µ–Ω–æ–≤ + 4 –≥—Ä–∞—Ñ–æ–≤—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)

---

## 9. –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ Go-Live MVP

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–±–ª–æ–∫–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞)

#### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

- [ ] ¬†VPS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (Ubuntu 24.04, 4vCPU/8GB RAM)
- [ ] ¬†‚ú® Zram 4GB (zstd, percent=50) –≤–º–µ—Å—Ç–æ swap
- [ ] ¬†Docker + Docker Compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- [ ] ¬†Traefik –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å TLS (Let's Encrypt)
- [ ] ¬†UFW firewall –∞–∫—Ç–∏–≤–µ–Ω (22/80/443)
- [ ] ¬†–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç (Netdata/cAdvisor)

#### –ü–æ–∏—Å–∫ –∏ –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è

- [ ] ¬†‚ú®¬†**–†—É—Å—Å–∫–∞—è –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è (pymorphy3) —Ä–∞–±–æ—Ç–∞–µ—Ç**
- [ ] ¬†SQLite FTS5 –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å content_lemma
- [ ] ¬†–°—Ç–æ–ø-—Å–ª–æ–≤–∞ RU –∑–∞–≥—Ä—É–∂–µ–Ω—ã
- [ ] ¬†Qdrant: –∫–æ–ª–ª–µ–∫—Ü–∏—è 384d + scalar int8 –∫–≤–∞–Ω—Ç–∏–∑–∞—Ü–∏—è
- [ ] ¬†HNSW –∏–Ω–¥–µ–∫—Å: m=16, ef_construct=100
- [ ] ¬†Payload –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã (lang, doc_id)

#### ML-–º–æ–¥–µ–ª–∏ (ONNX)

- [ ] ¬†e5-small –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –±–µ–Ω—á–º–∞—Ä–∫ –ø—Ä–æ–π–¥–µ–Ω (<300ms –Ω–∞ –∑–∞–ø—Ä–æ—Å)
- [ ] ¬†OMP_NUM_THREADS=2 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] ¬†bge-reranker –≤ lazy-pool (idle timeout 10 –º–∏–Ω)
- [ ] ¬†‚ú® xlm-roberta-base-squad2 (—ç–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA) —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] ¬†–ë–µ–Ω—á–º–∞—Ä–∫ —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞: 80 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∑–∞ <2 —Å–µ–∫

#### Pipeline

- [ ] ¬†–î–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π –ø–æ–∏—Å–∫: 200‚Üí80‚Üí12 —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] ¬†RRF k=60 –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –∑–æ–ª–æ—Ç–æ–º –Ω–∞–±–æ—Ä–µ
- [ ] ¬†–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π ef_search (64‚Üí96‚Üí128) —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] ¬†–ì—Ä–∞—Ñ–æ–≤–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ 1-hop (+4 —á–∞–Ω–∫–∞)
- [ ] ¬†JSON-—Å—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è

#### LLM –∏ Fallback

- [ ] ¬†‚ú® Circuit breaker –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] ¬†Groq + OpenRouter + OpenAI (–ø–ª–∞—Ç–Ω—ã–π fallback) —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] ¬†‚ú® –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∫–µ—à (threshold=0.87, TTL=7d) –∞–∫—Ç–∏–≤–µ–Ω
- [ ] ¬†–≠–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA fallback –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] ¬†–†–µ–∂–∏–º "—Ç–æ–ª—å–∫–æ –ø–æ–∏—Å–∫" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç snippets

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞

- [ ] ¬†–ó–æ–ª–æ—Ç–æ–π –Ω–∞–±–æ—Ä: –º–∏–Ω–∏–º—É–º 30 –≤–æ–ø—Ä–æ—Å–æ–≤ (70% RU / 30% EN)
- [ ] ¬†Recall@15 ‚â• 0.80 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
- [ ] ¬†Groundedness ‚â• 0.80 (–Ω–∞ –≤—ã–±–æ—Ä–∫–µ)
- [ ] ¬†Latency P95 –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö budget (E2E <13 —Å–µ–∫)
- [ ] ¬†Load test: 10 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ OOM
- [ ] ¬†–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ gating-–ø–æ—Ä–æ–≥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞

#### –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è

- [ ] ¬†–ë—ç–∫–∞–ø—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ, –≤–Ω–µ—à–Ω–∏–π storage)
- [ ] ¬†–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
- [ ] ¬†–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å trace_id
- [ ] ¬†Memory watchdog –∞–∫—Ç–∏–≤–µ–Ω (alert –ø—Ä–∏ >90% RAM)
- [ ] ¬†‚ú® Streamlit UI –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç

---

## 10. –ò–∑–≤–µ—Å—Ç–Ω—ã–µ —Ä–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏–∏

|–†–∏—Å–∫|–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å|Impact|–ú–∏—Ç–∏–≥–∞—Ü–∏—è|
|---|---|---|---|
|**OOM –ø—Ä–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ 300k —á–∞–Ω–∫–æ–≤**|–°—Ä–µ–¥–Ω—è—è|–í—ã—Å–æ–∫–∏–π|–ë–∞—Ç—á–∏–Ω–≥ –ø–æ 5k, zram, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –∞–≤—Ç–æ—É–Ω–ª–æ–∞–¥ –º–æ–¥–µ–ª–µ–π|
|**–†–µ—Ä–∞–Ω–∫–∏–Ω–≥ >2 —Å–µ–∫ –Ω–∞ 4vCPU**|–°—Ä–µ–¥–Ω—è—è|–°—Ä–µ–¥–Ω–∏–π|–°–æ–∫—Ä–∞—Ç–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–æ 60, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å int8 ONNX|
|**–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ LLM API –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã**|–í—ã—Å–æ–∫–∞—è|–°—Ä–µ–¥–Ω–∏–π|Circuit breaker + –ø–ª–∞—Ç–Ω—ã–π fallback ($5/–º–µ—Å)|
|**Recall <0.8 –Ω–∞ —Ä—É—Å—Å–∫–æ–º –±–µ–∑ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏**|‚ú® –í—ã—Å–æ–∫–∞—è|–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π|**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è pymorphy3**|
|**VPS –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ 50+ –∑–∞–ø—Ä–æ—Å–∞—Ö/–¥–µ–Ω—å**|–ù–∏–∑–∫–∞—è|–°—Ä–µ–¥–Ω–∏–π|Rate limiting, —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∫–µ—à (—Å–Ω–∏–∂–∞–µ—Ç –Ω–∞ 40%)|

---

## 11. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### –†–µ—Ñ–µ—Ä–µ–Ω—Å-–∫–æ–¥ (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞)

#### RU-–ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è + FTS5

Python

```
# lemmatizer.py
from pymorphy3 import MorphAnalyzer
import re

class RussianLemmatizer:
    # (—Å–º. —Ä–∞–∑–¥–µ–ª 4.3.2 –¥–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
    pass
```

#### RRF Fusion

Python

```
# fusion.py
def reciprocal_rank_fusion(vector_results, bm25_results, k=60, top_n=80):
    # (—Å–º. —Ä–∞–∑–¥–µ–ª 4.3.3)
    pass
```

#### Circuit Breaker –¥–ª—è LLM

Python

```
# llm_router.py
from circuitbreaker import circuit

class LLMRouter:
    # (—Å–º. —Ä–∞–∑–¥–µ–ª 4.6.1 –¥–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
    pass
```

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Docker Compose

YAML

```
version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:v1.7.4
    volumes:
      - ./data/qdrant:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 2G

  app:
    build: .
    volumes:
      - ./data/sqlite:/app/data
    environment:
      - OMP_NUM_THREADS=2
      - MKL_NUM_THREADS=2
    env_file:
      - .env
    networks:
      - internal
      - external
    depends_on:
      - qdrant
    deploy:
      resources:
        limits:
          memory: 4G

  traefik:
    image: traefik:v2.10
    command:
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=your@email.com"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./data/traefik:/letsencrypt
    networks:
      - external

networks:
  internal:
    driver: bridge
    internal: true
  external:
    driver: bridge
```

---

## 12. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è v11.0 vs v10.0

1. ‚ú®¬†**–†—É—Å—Å–∫–∞—è –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è**¬†‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –¥–ª—è 70% –∫–æ–Ω—Ç–µ–Ω—Ç–∞
2. ‚ú®¬†**–≠–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA fallback**¬†‚Äî –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å +40%, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç LLM API
3. ‚ú®¬†**Circuit breaker**¬†‚Äî —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –æ—Ç–∫–∞–∑–∞–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
4. ‚ú®¬†**–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∫–µ—à**¬†‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ LLM-–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 30-40%
5. ‚ú®¬†**Zram –≤–º–µ—Å—Ç–æ swap**¬†‚Äî –≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏ memory pressure
6. ‚ú®¬†**Thin wrapper**¬†‚Äî —ç–∫–æ–Ω–æ–º–∏—è ~200 MB RAM, –∫–æ–Ω—Ç—Ä–æ–ª—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã MVP

- **Recall@15:**¬†0.82-0.85 (—Å –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π)
- **Groundedness:**¬†0.80-0.88
- **Latency P95 (E2E):**¬†9-11 —Å–µ–∫—É–Ω–¥ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º), 5-7 —Å–µ–∫—É–Ω–¥ (fallback)
- **–î–æ–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:**¬†85-90% (LLM + —ç–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤–Ω—ã–π)
- **–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ RAM:**¬†5-6 GB –≤ –ø–∏–∫–µ, 3-4 GB –≤ idle
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**¬†99%+ uptime (–±–ª–∞–≥–æ–¥–∞—Ä—è fallback)

### –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ (—Å–µ–≥–æ–¥–Ω—è)

1. –§–æ—Ä–∫–Ω—É—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å VPS + zram
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å pymorphy3 –Ω–∞ sample-–¥–∞–Ω–Ω—ã—Ö –∏–∑ SiYuan
4. –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–µ 10 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∑–æ–ª–æ—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:**¬†11.0  
**–°—Ç–∞—Ç—É—Å:**¬†Production-Ready Blueprint  
**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**¬†2024  
**–°–ª–µ–¥—É—é—â–∏–π –æ–±–∑–æ—Ä:**¬†–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–µ–¥–µ–ª–∏ 2 (–æ—Ü–µ–Ω–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ pipeline)

---

_–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –∂–∏–≤—ã–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–º. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –º–µ—Ç—Ä–∏–∫ –∏ —Ä–∏—Å–∫–æ–≤ –¥–æ–ª–∂–Ω—ã –æ—Ç—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º._
